<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Junk Fee Removal Tester</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #1a1a2e;
      color: #eee;
      min-height: 100vh;
      padding: 20px;
    }

    .container { max-width: 1500px; margin: 0 auto; }

    header {
      background: linear-gradient(135deg, #4a6bd8 0%, #7a56b3 50%, #b14a7a 100%);
      color: white;
      padding: 24px 30px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { width: 56px; height: 56px; object-fit: contain; background: transparent; padding: 0; }
    header h1 { font-size: 22px; }
    header p { opacity: 0.85; font-size: 13px; margin-top: 4px; }

    .tabs { display: flex; gap: 10px; margin-bottom: 12px; }
    .tab {
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px solid #2a2a4a;
      background: #16213e;
      color: #a5b4fc;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    .tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
      border-color: transparent;
    }

    .controls-panel { margin-bottom: 24px; }
    .controls-grid { display: grid; grid-template-columns: 320px 1fr; gap: 16px; align-items: start; }
    .controls-col { display: flex; flex-direction: column; gap: 8px; }
    .controls-col.left-controls { gap: 0; }
    .controls-box { background: #16213e; border-radius: 10px; padding: 18px 20px; border: 1px solid #202b4a; }
    .left-actions { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }

    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input,
    .form-group select { padding: 9px 12px; background: #0f3460; border: 1px solid #2a2a4a; border-radius: 6px; color: #eee; font-size: 13px; }
    .form-group input:focus,
    .form-group select:focus { outline: none; border-color: #667eea; }

    .fg-base { flex: 2; min-width: 240px; }
    .fg-flow { flex: 1; min-width: 220px; }
    .fg-api  { flex: 2; min-width: 240px; }
    .fg-auth { flex: 1; min-width: 200px; }

    button {
      padding: 10px 24px;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.45; cursor: default; transform: none; }

    .btn-run { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 36px; font-size: 14px; }
    .btn-run:hover:not(:disabled) { box-shadow: 0 4px 15px rgba(102,126,234,0.4); }

    .btn-cancel { background: #5f1e1e; color: #ef9a9a; padding: 10px 24px; display: none; }
    .btn-cancel:hover { background: #7a2828; }

    .btn-load { background: transparent; color: #667eea; border: 1px solid #667eea; padding: 10px 18px; }
    .btn-load:hover { background: rgba(102,126,234,0.1); }

    .btn-toggle { background: transparent; color: #f0c040; border: 1px solid #f0c040; padding: 8px 14px; }
    .btn-toggle.active { background: rgba(240,192,64,0.15); box-shadow: 0 0 8px rgba(240,192,64,0.25); }

    .btn-save { background: transparent; color: #81c784; border: 1px solid #81c784; padding: 6px 10px; font-size: 11px; border-radius: 6px; }
    .btn-save:hover { background: rgba(129,199,132,0.12); }

    .btn-copy { background: transparent; color: #a5b4fc; border: 1px solid #3a4b6f; padding: 6px 10px; font-size: 11px; border-radius: 6px; }
    .btn-copy:hover { background: rgba(165,180,252,0.12); }
    .btn-copy.copied { color: #81c784; border-color: #81c784; background: rgba(129,199,132,0.12); }

    .status-bar { width: 100%; padding: 10px 16px; border-radius: 6px; font-size: 13px; display: none; margin-top: 8px; }
    .status-bar.loading { display: block; background: rgba(33,150,243,0.15); color: #64b5f6; }
    .status-bar.success { display: block; background: rgba(76,175,80,0.15); color: #81c784; }
    .status-bar.error   { display: block; background: rgba(244,67,54,0.15); color: #ef9a9a; }

    .section-title { color: #a5b4fc; font-size: 16px; margin: 28px 0 12px 0; display: flex; align-items: center; gap: 8px; }

    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }

    .card { background: #0f3460; border: 1px solid #2a2a4a; border-radius: 10px; padding: 16px; display: flex; flex-direction: column; align-self: start; }
    .card h3 { font-size: 13px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .card.original h3 { color: #64b5f6; }
    .card.updated  h3 { color: #81c784; }
    .card.updated pre { background: #142a4a; }

    .card pre,
    .card textarea { min-height: 220px; height: auto; overflow: visible; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.6; background: #1a1a2e; border-radius: 6px; padding: 12px; color: #ddd; border: 1px solid #2a2a4a; resize: none; }

    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }

    .fee-highlight { background: rgba(240,192,64,0.25); color: #f0c040; border-radius: 3px; padding: 0 2px; }

    .debug-panel { width: 100%; margin-top: 8px; background: #0f3460; border: 1px solid #2a2a4a; border-radius: 8px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; color: #ddd; display: none; white-space: pre-wrap; max-height: 260px; overflow: auto; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(10, 12, 24, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal { width: 100%; max-width: 520px; background: #16213e; border: 1px solid #2a2a4a; border-radius: 12px; padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,0.35); }
    .modal h3 { color: #a5b4fc; margin-bottom: 8px; font-size: 16px; }
    .modal .form-group input,
    .modal .form-group textarea { background: #0f3460; border: 1px solid #2a2a4a; color: #eee; border-radius: 6px; padding: 10px 12px; font-size: 13px; }
    .modal .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
    .btn-secondary { background: #2a2a4a; color: #ddd; border: 1px solid #3a3a5a; }

    @media (max-width: 900px) {
      .controls-grid { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <div class="header-left">
        <img class="logo" src="jetstream-white.png" alt="Jetstream" />
        <div>
          <h1>üè® Junk Fee Removal Tester</h1>
          <p>Resort + Property ‚Äî Langflow Execution UI</p>
        </div>
      </div>
      <span id="timer" style="font-size:13px; opacity:0.8;"></span>
    </header>

    <div class="tabs">
      <button class="tab active" id="tab-resort">Resort Flow</button>
      <button class="tab" id="tab-property">Property Flow</button>
    </div>

    <div class="controls-panel">
      <div class="controls-grid">
        <div class="controls-col controls-box left-controls">
          <div class="form-group">
            <label id="idLabel">Resort ID</label>
            <input id="entityId" type="text" value="5642" placeholder="e.g. 5642" />
          </div>
          <div class="left-actions">
            <button class="btn-run" id="runBtn">üöÄ Run Flow</button>
            <button class="btn-cancel" id="cancelBtn">‚úñ Cancel</button>
            <button class="btn-load" id="loadBtn">üì• Load from Langflow</button>
          </div>
        </div>

        <div class="controls-col controls-box">
          <div class="controls-row" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="form-group fg-base">
              <label>Langflow Base URL</label>
              <input id="baseUrl" type="text" value="https://langflow-staging.leavetown.com" />
            </div>
            <div class="form-group fg-flow">
              <label>Flow ID</label>
              <input id="flowId" type="text" value="" placeholder="Flow UUID" />
            </div>
          </div>
          <div class="controls-row" style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="form-group fg-api">
              <label>Langflow API Key</label>
              <input id="apiKey" type="password" placeholder="Paste your Langflow API key" />
            </div>
            <div class="form-group fg-auth">
              <label>Auth Header</label>
              <select id="authMode">
                <option value="x-api-key">x-api-key</option>
                <option value="bearer">Authorization: Bearer</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="status" class="status-bar" role="status" aria-live="polite"></div>
      <div id="debug" class="debug-panel"></div>
    </div>

    <div class="section-title">üß† Editable Prompts</div>

    <div id="prompts-resort" class="grid">
      <div class="card">
        <div class="card-header">
          <h3>Policies Prompt</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn-copy" onclick="copyFrom('policiesPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('policies')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="policiesPrompt"></textarea>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>RAI (Arrival Info) Prompt</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn-copy" onclick="copyFrom('raiPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('rai')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="raiPrompt"></textarea>
      </div>
    </div>

    <div id="prompts-property" class="grid" style="display:none;">
      <div class="card">
        <div class="card-header">
          <h3>Home Truth Prompt (HT)</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn-copy" onclick="copyFrom('htPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('home_truth')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="htPrompt"></textarea>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Long Description Prompt (LD)</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn-copy" onclick="copyFrom('ldPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('long_description')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="ldPrompt"></textarea>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Short Description Prompt (SD)</h3>
          <div style="display:flex; gap:8px;">
            <button class="btn-copy" onclick="copyFrom('sdPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('short_description')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="sdPrompt"></textarea>
      </div>
    </div>

    <div class="section-title">
      üß™ Test Results
      <button class="btn-toggle" id="highlightBtn" style="margin-left:8px;">üí∞ Highlight Fees</button>
    </div>

    <div id="results-resort">
      <div class="section-title">üìã Policies</div>
      <div class="grid">
        <div class="card original">
          <div class="card-header">
            <h3>Original Policies</h3>
            <button class="btn-copy" onclick="copyFrom('origPolicies', this)">üìã</button>
          </div>
          <pre id="origPolicies">Waiting for flow‚Ä¶</pre>
        </div>
        <div class="card updated">
          <div class="card-header">
            <h3>Updated Policies</h3>
            <button class="btn-copy" onclick="copyFrom('updatedPolicies', this)">üìã</button>
          </div>
          <pre id="updatedPolicies">Waiting for flow‚Ä¶</pre>
        </div>
      </div>

      <div class="section-title">üìù Arrival Info (RAI)</div>
      <div class="grid">
        <div class="card original">
          <div class="card-header">
            <h3>Original RAI</h3>
            <button class="btn-copy" onclick="copyFrom('origRAI', this)">üìã</button>
          </div>
          <pre id="origRAI">Waiting for flow‚Ä¶</pre>
        </div>
        <div class="card updated">
          <div class="card-header">
            <h3>Updated RAI</h3>
            <button class="btn-copy" onclick="copyFrom('updatedRAI', this)">üìã</button>
          </div>
          <pre id="updatedRAI">Waiting for flow‚Ä¶</pre>
        </div>
      </div>
    </div>

    <div id="results-property" style="display:none;">
      <div class="section-title">üè† Home Truth (HT)</div>
      <div class="grid">
        <div class="card original">
          <div class="card-header">
            <h3>Original HT</h3>
            <button class="btn-copy" onclick="copyFrom('origHT', this)">üìã</button>
          </div>
          <pre id="origHT">Waiting for flow‚Ä¶</pre>
        </div>
        <div class="card updated">
          <div class="card-header">
            <h3>Updated HT</h3>
            <button class="btn-copy" onclick="copyFrom('updatedHT', this)">üìã</button>
          </div>
          <pre id="updatedHT">Waiting for flow‚Ä¶</pre>
        </div>
      </div>

      <div class="section-title">üìù Long Description (LD)</div>
      <div class="grid">
        <div class="card original">
          <div class="card-header">
            <h3>Original LD</h3>
            <button class="btn-copy" onclick="copyFrom('origLD', this)">üìã</button>
          </div>
          <pre id="origLD">Waiting for flow‚Ä¶</pre>
        </div>
        <div class="card updated">
          <div class="card-header">
            <h3>Updated LD</h3>
            <button class="btn-copy" onclick="copyFrom('updatedLD', this)">üìã</button>
          </div>
          <pre id="updatedLD">Waiting for flow‚Ä¶</pre>
        </div>
      </div>

      <div class="section-title">üìù Short Description (SD)</div>
      <div class="grid">
        <div class="card original">
          <div class="card-header">
            <h3>Original SD</h3>
            <button class="btn-copy" onclick="copyFrom('origSD', this)">üìã</button>
          </div>
          <pre id="origSD">Waiting for flow‚Ä¶</pre>
        </div>
        <div class="card updated">
          <div class="card-header">
            <h3>Updated SD</h3>
            <button class="btn-copy" onclick="copyFrom('updatedSD', this)">üìã</button>
          </div>
          <pre id="updatedSD">Waiting for flow‚Ä¶</pre>
        </div>
      </div>
    </div>
  </div>

  <div id="saveModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="saveTitle">
    <div class="modal">
      <h3 id="saveTitle">Save Prompt Version</h3>
      <div class="form-group">
        <label>Version Name</label>
        <input id="versionName" type="text" placeholder="e.g. v1 - remove fees carefully" />
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Comment</label>
        <textarea id="versionComment" rows="4" placeholder="What changed and why?"></textarea>
      </div>
      <div class="form-group" style="margin-top:10px;">
        <label>Created By</label>
        <input id="createdBy" type="text" placeholder="Your name or initials" />
      </div>
      <div class="actions">
        <button class="btn-secondary" id="closeModal">Cancel</button>
        <button class="btn-run" id="saveVersionBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/a/macros/jetstreamtech.io/s/AKfycbwkybjhql7EDzFFG-JYss340KwmkazPTWELbalVC5j2-CbM0ud4iGT-Cci4Th8RxabN-g/exec';

    const tabResort = document.getElementById('tab-resort');
    const tabProperty = document.getElementById('tab-property');
    const idLabel = document.getElementById('idLabel');
    const entityId = document.getElementById('entityId');
    const baseUrl = document.getElementById('baseUrl');
    const flowId = document.getElementById('flowId');
    const apiKey = document.getElementById('apiKey');
    const authMode = document.getElementById('authMode');
    const runBtn = document.getElementById('runBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const loadBtn = document.getElementById('loadBtn');
    const highlightBtn = document.getElementById('highlightBtn');
    const status = document.getElementById('status');
    const debug = document.getElementById('debug');
    const timer = document.getElementById('timer');
    const saveModal = document.getElementById('saveModal');
    const versionName = document.getElementById('versionName');
    const versionComment = document.getElementById('versionComment');
    const createdBy = document.getElementById('createdBy');
    const closeModal = document.getElementById('closeModal');
    const saveVersionBtn = document.getElementById('saveVersionBtn');

    const FLOW_CONFIG = {
      resort: {
        label: 'Resort ID',
        flowId: 'dee35898-a5bb-4214-9001-5940d98d39be',
        prompts: [
          { id: 'policiesPrompt', type: 'policies', node: 'Prompt Template-AVk4F' },
          { id: 'raiPrompt', type: 'rai', node: 'Prompt Template-9r1K1' }
        ],
        outputs: [
          { id: 'origPolicies', keys: ['policies','original'] },
          { id: 'updatedPolicies', keys: ['policies','updated'] },
          { id: 'origRAI', keys: ['rai','original'] },
          { id: 'updatedRAI', keys: ['rai','updated'] }
        ]
      },
      property: {
        label: 'Property ID',
        flowId: 'dee35898-a5bb-4214-9001-5940d98d39be',
        prompts: [
          { id: 'htPrompt', type: 'home_truth', node: 'Prompt Template-9r1K1' },
          { id: 'ldPrompt', type: 'long_description', node: 'Prompt Template-AVk4F' },
          { id: 'sdPrompt', type: 'short_description', node: 'Prompt Template-Bxpqm' }
        ],
        outputs: [
          { id: 'origHT', componentId: 'ChatOutput-VRLWh' },
          { id: 'updatedHT', componentId: 'ChatOutput-zlIsF' },
          { id: 'origLD', componentId: 'ChatOutput-bJLcB' },
          { id: 'updatedLD', componentId: 'ChatOutput-wOxYd' },
          { id: 'origSD', componentId: 'ChatOutput-iukQ4' },
          { id: 'updatedSD', componentId: 'ChatOutput-EMQLT' }
        ]
      }
    };

    let currentFlow = 'property';
    let isRunning = false;
    let ignoreResult = false;
    let timerInterval = null;
    let currentPromptType = null;
    let highlightOn = false;

    const draftKeys = {
      policies: 'draft:policies',
      rai: 'draft:rai',
      home_truth: 'draft:home_truth',
      long_description: 'draft:long_description',
      short_description: 'draft:short_description'
    };

    function getBaseUrl() { return baseUrl.value.trim().replace(/\/+$/, ''); }
    function getFlowId() { return flowId.value.trim(); }

    function setFlow(flowKey) {
      currentFlow = flowKey;
      tabResort.classList.toggle('active', flowKey === 'resort');
      tabProperty.classList.toggle('active', flowKey === 'property');
      idLabel.textContent = FLOW_CONFIG[flowKey].label;
      entityId.value = '';
      flowId.value = FLOW_CONFIG[flowKey].flowId || '';
      document.getElementById('prompts-resort').style.display = flowKey === 'resort' ? 'grid' : 'none';
      document.getElementById('prompts-property').style.display = flowKey === 'property' ? 'grid' : 'none';
      document.getElementById('results-resort').style.display = flowKey === 'resort' ? 'block' : 'none';
      document.getElementById('results-property').style.display = flowKey === 'property' ? 'block' : 'none';
      restoreDrafts(flowKey);
      autoResizeAllPrompts();
    }

    function setStatus(type, msg) {
      status.textContent = msg;
      status.className = 'status-bar' + (type ? ' ' + type : '');
    }

    function setDebug(msg) {
      if (!msg) {
        debug.style.display = 'none';
        debug.textContent = '';
        return;
      }
      debug.style.display = 'block';
      debug.textContent = msg;
    }

    function buildAuthHeaders(key) {
      const mode = authMode.value;
      if (mode === 'bearer') return { Authorization: `Bearer ${key}` };
      return { 'x-api-key': key };
    }

    function normalize(str) { return (str || '').toLowerCase().replace(/[^a-z0-9]/g, ''); }

    function findOutput(outputs, mustInclude, componentId) {
      if (componentId) {
        const match = outputs.find(o => o.component_id === componentId);
        return match?.results?.message?.text || '‚Äî';
      }
      const keys = mustInclude.map(normalize);
      const match = outputs.find(o => {
        const name = normalize(o.component_display_name);
        const id   = normalize(o.component_id);
        return keys.every(k => name.includes(k) || id.includes(k));
      });
      return match?.results?.message?.text || '‚Äî';
    }

    function setOutput(id, text) {
      const el = document.getElementById(id);
      el.dataset.raw = text || '';
      if (highlightOn) el.innerHTML = highlightFees(el.dataset.raw);
      else el.textContent = el.dataset.raw || '‚Äî';
    }

    function toggleHighlight() {
      highlightOn = !highlightOn;
      highlightBtn.classList.toggle('active', highlightOn);
      const outs = FLOW_CONFIG[currentFlow].outputs.map(o => o.id);
      outs.forEach(id => {
        const el = document.getElementById(id);
        const raw = el.dataset.raw || el.textContent || '';
        setOutput(id, raw);
      });
    }

    function highlightFees(text) {
      if (!text) return '';
      const keywords = [
        'pack', 's√©r√©nit√©', 'serenity', 'cleaning', 'bed', 'beds', 'linen', 'linens',
        'bedding', 'towels', 'towel', 'sheets', 'sheet', 'made on arrival',
        'euro', 'fee', 'pack m√©nage', 'pack linge', 'kit'
      ];
      const escaped = keywords.map(k => k.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).sort((a, b) => b.length - a.length);
      const wordRe = new RegExp(`\\b(${escaped.join('|')})\\b`, 'gi');
      const withWords = text.replace(wordRe, '<span class="fee-highlight">$1</span>');
      return withWords.replace(/‚Ç¨/g, '<span class="fee-highlight">‚Ç¨</span>');
    }

    async function copyFrom(id, btn) {
      const el = document.getElementById(id);
      if (!el) return;
      const text = el.value !== undefined ? el.value : (el.dataset.raw || el.textContent || '');
      const restore = () => { if (!btn) return; btn.textContent = 'üìã'; btn.classList.remove('copied'); };
      try {
        await navigator.clipboard.writeText(text);
        if (btn) { btn.textContent = 'üìã Copied!'; btn.classList.add('copied'); setTimeout(restore, 1200); }
        setStatus('success', 'Copied!');
      } catch {
        const ta = document.createElement('textarea');
        ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
        if (btn) { btn.textContent = 'üìã Copied!'; btn.classList.add('copied'); setTimeout(restore, 1200); }
        setStatus('success', 'Copied!');
      }
    }

    function startTimer() {
      const start = Date.now();
      timer.textContent = '‚è± 0s';
      timerInterval = setInterval(() => {
        const s = Math.round((Date.now() - start) / 1000);
        timer.textContent = `‚è± ${s}s`;
      }, 1000);
    }

    function stopTimer() { clearInterval(timerInterval); }

    function autoResize(el) { if (!el) return; el.style.height = 'auto'; el.style.height = `${el.scrollHeight}px`; }
    function autoResizeAllPrompts() {
      ['policiesPrompt','raiPrompt','htPrompt','ldPrompt','sdPrompt'].forEach(id => {
        const el = document.getElementById(id);
        if (el && el.offsetParent !== null) autoResize(el);
      });
    }

    function saveDraft(promptType, textVal) { const key = draftKeys[promptType]; if (key) localStorage.setItem(key, textVal || ''); }
    function loadDraft(promptType) { const key = draftKeys[promptType]; return key ? (localStorage.getItem(key) || '') : ''; }
    function restoreDrafts(flowKey) {
      const cfg = FLOW_CONFIG[flowKey];
      cfg.prompts.forEach(p => {
        const el = document.getElementById(p.id);
        if (!el) return;
        const draft = loadDraft(p.type);
        if (draft) el.value = draft;
      });
      autoResizeAllPrompts();
    }

    function escapeHtml(s) {
      return (s || '').replace(/[&<>"]|'/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
    }
    const promptTypeMap = {
      policies: 'policiesPrompt',
      rai: 'raiPrompt',
      home_truth: 'htPrompt',
      long_description: 'ldPrompt',
      short_description: 'sdPrompt'
    };

    async function loadPrompts() {
      const key = apiKey.value.trim();
      if (!key) { setStatus('error', 'API key required'); return; }
      if (!getFlowId()) { setStatus('error', 'Flow ID required'); return; }
      setStatus('loading', 'Loading prompts from Langflow‚Ä¶');
      setDebug('');
      try {
        const res = await fetch(`${getBaseUrl()}/api/v1/flows/${getFlowId()}`, { headers: buildAuthHeaders(key) });
        if (!res.ok) { const text = await res.text(); throw new Error(`HTTP ${res.status}: ${text.substring(0, 500)}`); }
        const flow = await res.json();
        const nodes = flow.data.nodes;
        const cfg = FLOW_CONFIG[currentFlow];
        cfg.prompts.forEach(p => {
          const n = nodes.find(x => x.id === p.node);
          const val = n?.data?.node?.template?.template?.value || '';
          const el = document.getElementById(p.id);
          if (el) { el.value = val; saveDraft(p.type, val); }
        });
        autoResizeAllPrompts();
        setStatus('success', 'Original prompts loaded');
      } catch (e) {
        setStatus('error', 'Failed to load prompts');
        setDebug(String(e?.message || e));
      }
    }

    function cancelRun() {
      if (!isRunning) return;
      ignoreResult = true;
      isRunning = false;
      runBtn.disabled = false;
      runBtn.textContent = 'üöÄ Run Flow';
      cancelBtn.style.display = 'none';
      stopTimer();
      setStatus('error', 'Run cancelled by user');
    }

    async function runFlow() {
      if (isRunning) return;
      const key = apiKey.value.trim();
      const entity = entityId.value.trim();
      if (!key) { setStatus('error', 'API key required'); return; }
      if (!entity) { setStatus('error', `${FLOW_CONFIG[currentFlow].label} is required`); return; }
      if (!getFlowId()) { setStatus('error', 'Flow ID required'); return; }
      isRunning = true;
      ignoreResult = false;
      runBtn.disabled = true;
      runBtn.textContent = '‚è≥ Running‚Ä¶';
      cancelBtn.style.display = 'inline-block';
      setStatus('loading', 'Running flow‚Ä¶');
      setDebug('');
      startTimer();

      try {
        const tweaks = {};
        FLOW_CONFIG[currentFlow].prompts.forEach(p => {
          const el = document.getElementById(p.id);
          const val = el ? el.value.trim() : '';
          if (val) tweaks[p.node] = { template: val };
        });

        const res = await fetch(`${getBaseUrl()}/api/v1/run/${getFlowId()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...buildAuthHeaders(key) },
          body: JSON.stringify({ input_type: 'chat', output_type: 'chat', input_value: entity, tweaks })
        });

        const raw = await res.text();
        if (!res.ok) { setDebug(raw); throw new Error(`HTTP ${res.status}: ${raw.substring(0, 500)}`); }
        const data = raw ? JSON.parse(raw) : {};
        if (ignoreResult) return;
        const outputs = data.outputs?.[0]?.outputs || [];
        FLOW_CONFIG[currentFlow].outputs.forEach(o => {
          setOutput(o.id, findOutput(outputs, o.keys || [], o.componentId));
        });
        setStatus('success', 'Flow completed successfully');
      } catch (e) {
        if (!ignoreResult) { setStatus('error', 'Flow failed'); setDebug(String(e?.message || e)); }
      } finally {
        isRunning = false;
        runBtn.disabled = false;
        runBtn.textContent = 'üöÄ Run Flow';
        cancelBtn.style.display = 'none';
        stopTimer();
      }
    }

    function openSaveModal(type) { currentPromptType = type; versionName.value = ''; versionComment.value = ''; saveModal.style.display = 'flex'; }
    function closeSaveModal() { saveModal.style.display = 'none'; currentPromptType = null; }

    async function savePromptVersion() {
      if (!currentPromptType) return;
      const el = document.getElementById(promptTypeMap[currentPromptType]);
      const promptText = el ? el.value : '';
      if (!promptText) { setStatus('error', 'Prompt is empty'); closeSaveModal(); return; }
      if (el) saveDraft(currentPromptType, promptText);

      const payload = { flow_id: getFlowId(), prompt_type: currentPromptType, version_name: versionName.value.trim(), comment: versionComment.value.trim(), prompt_text: promptText, created_by: createdBy.value.trim() };

      try {
        const body = new URLSearchParams(payload);
        const res = await fetch(GAS_URL, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' }, body });
        const raw = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${raw.substring(0, 500)}`);
        setStatus('success', '‚úÖ Saved!');
      } catch (e) {
        setStatus('error', 'Failed to save prompt version');
        setDebug(String(e?.message || e));
      } finally {
        closeSaveModal();
      }
    }

    ['policiesPrompt','raiPrompt','htPrompt','ldPrompt','sdPrompt'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', () => {
        autoResize(el);
        const t = Object.keys(promptTypeMap).find(k => promptTypeMap[k] === id);
        if (t) saveDraft(t, el.value);
      });
    });

    tabResort.addEventListener('click', () => setFlow('resort'));
    tabProperty.addEventListener('click', () => setFlow('property'));
    runBtn.addEventListener('click', runFlow);
    cancelBtn.addEventListener('click', cancelRun);
    loadBtn.addEventListener('click', loadPrompts);
    highlightBtn.addEventListener('click', toggleHighlight);
    closeModal.addEventListener('click', closeSaveModal);
    saveVersionBtn.addEventListener('click', savePromptVersion);

    window.addEventListener('DOMContentLoaded', () => setFlow('property'));
  </script>
</body>
</html>
