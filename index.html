<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Vacanc√©ole Content Update Tester</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #1a1a2e; color: #eee; min-height: 100vh; padding: 20px; }
    .container { max-width: 1500px; margin: 0 auto; }
    header { background: linear-gradient(135deg, #4a6bd8 0%, #7a56b3 50%, #b14a7a 100%); color: white; padding: 24px 30px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .header-left { display: flex; align-items: center; gap: 12px; }
    .logo { width: 56px; height: 56px; object-fit: contain; }
    header h1 { font-size: 22px; }
    header p { opacity: 0.85; font-size: 13px; margin-top: 4px; }

    .controls-panel { margin-bottom: 24px; }
    .controls-grid { display: grid; grid-template-columns: 320px 1fr; gap: 16px; align-items: start; }
    .controls-col { display: flex; flex-direction: column; gap: 8px; }
    .controls-col.left-controls { gap: 0; }
    .controls-box { background: #16213e; border-radius: 10px; padding: 18px 20px; border: 1px solid #202b4a; }
    .left-actions { display: flex; flex-direction: column; gap: 2px; margin-top: 0; }

    .form-group { display: flex; flex-direction: column; gap: 4px; }
    .form-group label { font-size: 11px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; }
    .form-group input, .form-group select { padding: 9px 12px; background: #0f3460; border: 1px solid #2a2a4a; border-radius: 6px; color: #eee; font-size: 13px; }
    .form-group input:focus, .form-group select:focus { outline: none; border-color: #667eea; }

    .fg-base { flex: 2; min-width: 240px; }
    .fg-flow { flex: 1; min-width: 220px; }
    .fg-api  { flex: 2; min-width: 240px; }
    .fg-auth { flex: 1; min-width: 200px; }

    button { padding: 10px 24px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    button:disabled { opacity: 0.45; cursor: default; transform: none; }

    .btn-run { background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 10px 36px; font-size: 14px; }
    .btn-cancel { background: #5f1e1e; color: #ef9a9a; display: none; }
    .btn-load { background: transparent; color: #667eea; border: 1px solid #667eea; }
    .btn-load:hover { background: rgba(102,126,234,0.1); }

    .btn-save { background: transparent; color: #81c784; border: 1px solid #81c784; padding: 6px 10px; font-size: 11px; border-radius: 6px; }
    .btn-copy { background: transparent; color: #a5b4fc; border: 1px solid #3a4b6f; padding: 6px 10px; font-size: 11px; border-radius: 6px; }
    .btn-copy.copied { color: #81c784; border-color: #81c784; background: rgba(129,199,132,0.12); }
    .btn-toggle { background: transparent; color: #f0c040; border: 1px solid #f0c040; padding: 8px 14px; }
    .btn-toggle.active { background: rgba(240,192,64,0.15); }
    .version-select { background: #0f3460; border: 1px solid #2a2a4a; color: #ddd; border-radius: 6px; font-size: 11px; padding: 6px 8px; min-width: 180px; }

    .status-bar { width: 100%; padding: 10px 16px; border-radius: 6px; font-size: 13px; display: none; margin-top: 8px; }
    .status-bar.loading { display: block; background: rgba(33,150,243,0.15); color: #64b5f6; }
    .status-bar.success { display: block; background: rgba(76,175,80,0.15); color: #81c784; }
    .status-bar.error   { display: block; background: rgba(244,67,54,0.15); color: #ef9a9a; }

    .section-title { color: #a5b4fc; font-size: 16px; margin: 28px 0 12px 0; display: flex; align-items: center; gap: 8px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; align-items: start; }

    .card { background: #0f3460; border: 1px solid #2a2a4a; border-radius: 10px; padding: 16px; display: flex; flex-direction: column; }
    .card h3 { font-size: 13px; color: #aaa; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .card.original h3 { color: #64b5f6; }
    .card.updated h3 { color: #81c784; }
    .card.updated pre { background: #142a4a; }

    .card pre, .card textarea {
      min-height: 220px;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
      background: #1a1a2e;
      border-radius: 6px;
      padding: 12px;
      color: #ddd;
      border: 1px solid #2a2a4a;
      resize: none;
    }

    .card-header { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .fee-highlight { background: rgba(240,192,64,0.25); color: #f0c040; border-radius: 3px; padding: 0 2px; }
    .debug-panel { width: 100%; margin-top: 8px; background: #0f3460; border: 1px solid #2a2a4a; border-radius: 8px; padding: 10px; font-family: 'Courier New', monospace; font-size: 12px; color: #ddd; display: none; white-space: pre-wrap; max-height: 260px; overflow: auto; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(10,12,24,.6); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal { width: 100%; max-width: 520px; background: #16213e; border: 1px solid #2a2a4a; border-radius: 12px; padding: 18px; }
    .modal h3 { color: #a5b4fc; margin-bottom: 8px; font-size: 16px; }
    .modal .form-group input, .modal .form-group textarea { background: #0f3460; border: 1px solid #2a2a4a; color: #eee; border-radius: 6px; padding: 10px 12px; font-size: 13px; }
    .modal .actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 12px; }
    .btn-secondary { background: #2a2a4a; color: #ddd; border: 1px solid #3a3a5a; }

    @media (max-width: 900px) {
      .controls-grid { grid-template-columns: 1fr; }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="header-left">
        <img class="logo" src="jetstream-white.png" alt="Jetstream" />
        <div>
          <h1>üè® Vacanc√©ole Content Update Tester</h1>
          <p>Property Content ‚Äî Langflow Execution UI</p>
        </div>
      </div>
      <span id="timer" style="font-size:13px; opacity:0.8;"></span>
    </header>

    <div class="controls-panel">
      <div class="controls-grid">
        <div class="controls-col controls-box left-controls">
          <div class="form-group">
            <label id="idLabel">Property ID</label>
            <input id="entityId" type="text" value="6364" placeholder="e.g. 6364" />
          </div>
          <div class="left-actions">
            <button class="btn-run" id="runBtn">üöÄ Run Flow</button>
            <button class="btn-cancel" id="cancelBtn">‚úñ Cancel</button>
            <button class="btn-load" id="loadBtn">üì• Load from Langflow</button>
            <button class="btn-load" id="refreshVersionsBtn">‚Üª Refresh Saved Versions</button>
          </div>
        </div>

        <div class="controls-col controls-box">
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="form-group fg-base">
              <label>Langflow Base URL</label>
              <input id="baseUrl" type="text" value="https://langflow-staging.leavetown.com" />
            </div>
            <div class="form-group fg-flow">
              <label>Flow ID</label>
              <input id="flowId" type="text" value="dee35898-a5bb-4214-9001-5940d98d39be" placeholder="Flow UUID" />
            </div>
          </div>
          <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
            <div class="form-group fg-api">
              <label>Langflow API Key</label>
              <input id="apiKey" type="password" placeholder="Paste your Langflow API key" />
            </div>
            <div class="form-group fg-auth">
              <label>Auth Header</label>
              <select id="authMode">
                <option value="x-api-key">x-api-key</option>
                <option value="bearer">Authorization: Bearer</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div id="status" class="status-bar"></div>
      <div id="debug" class="debug-panel"></div>
    </div>

    <div class="section-title">üß† Editable Prompts</div>
    <div class="grid">
      <div class="card">
        <div class="card-header">
          <h3>Home Truth Prompt (HT)</h3>
          <div style="display:flex; gap:8px;">
            <select class="version-select" id="versions-home_truth"></select>
            <button class="btn-copy" onclick="copyFrom('htPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('home_truth')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="htPrompt"></textarea>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Long Description Prompt (LD)</h3>
          <div style="display:flex; gap:8px;">
            <select class="version-select" id="versions-long_description"></select>
            <button class="btn-copy" onclick="copyFrom('ldPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('long_description')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="ldPrompt"></textarea>
      </div>
      <div class="card">
        <div class="card-header">
          <h3>Short Description Prompt (SD)</h3>
          <div style="display:flex; gap:8px;">
            <select class="version-select" id="versions-short_description"></select>
            <button class="btn-copy" onclick="copyFrom('sdPrompt', this)">üìã</button>
            <button class="btn-save" onclick="openSaveModal('short_description')">üíæ Save Version</button>
          </div>
        </div>
        <textarea id="sdPrompt"></textarea>
      </div>
    </div>

    <div class="section-title">üß™ Test Results <button class="btn-toggle" id="highlightBtn" style="margin-left:8px;">üîé Highlight Terms</button></div>

    <div class="section-title">üè† Home Truth (HT)</div>
    <div class="grid">
      <div class="card original"><div class="card-header"><h3>Original HT</h3><button class="btn-copy" onclick="copyFrom('origHT', this)">üìã</button></div><pre id="origHT">Waiting for flow...</pre></div>
      <div class="card updated"><div class="card-header"><h3>Updated HT</h3><button class="btn-copy" onclick="copyFrom('updatedHT', this)">üìã</button></div><pre id="updatedHT">Waiting for flow...</pre></div>
    </div>

    <div class="section-title">üìù Long Description (LD)</div>
    <div class="grid">
      <div class="card original"><div class="card-header"><h3>Original LD</h3><button class="btn-copy" onclick="copyFrom('origLD', this)">üìã</button></div><pre id="origLD">Waiting for flow...</pre></div>
      <div class="card updated"><div class="card-header"><h3>Updated LD</h3><button class="btn-copy" onclick="copyFrom('updatedLD', this)">üìã</button></div><pre id="updatedLD">Waiting for flow...</pre></div>
    </div>

    <div class="section-title">üìù Short Description (SD)</div>
    <div class="grid">
      <div class="card original"><div class="card-header"><h3>Original SD</h3><button class="btn-copy" onclick="copyFrom('origSD', this)">üìã</button></div><pre id="origSD">Waiting for flow...</pre></div>
      <div class="card updated"><div class="card-header"><h3>Updated SD</h3><button class="btn-copy" onclick="copyFrom('updatedSD', this)">üìã</button></div><pre id="updatedSD">Waiting for flow...</pre></div>
    </div>
  </div>

  <div id="saveModal" class="modal-backdrop">
    <div class="modal">
      <h3>Save Prompt Version</h3>
      <div class="form-group"><label>Version Name</label><input id="versionName" type="text" /></div>
      <div class="form-group" style="margin-top:10px;"><label>Comment</label><textarea id="versionComment" rows="4"></textarea></div>
      <div class="form-group" style="margin-top:10px;"><label>Created By</label><input id="createdBy" type="text" /></div>
      <div class="actions">
        <button class="btn-secondary" id="closeModal">Cancel</button>
        <button class="btn-run" id="saveVersionBtn">Save</button>
      </div>
    </div>
  </div>

  <script>
    const GAS_URL = 'https://script.google.com/macros/s/AKfycbx-_bKf-L-XtkP0aaKWaZN3YeQgl_r_Zdn9zdyQoBwT4EoA3sC11NmHcRCb2XOQdtWQXA/exec';
    const PROJECT = 'vacanceole';

    const el = id => document.getElementById(id);
    const entityId = el('entityId'), baseUrl = el('baseUrl'), flowId = el('flowId'), apiKey = el('apiKey'), authMode = el('authMode');
    const runBtn = el('runBtn'), cancelBtn = el('cancelBtn'), loadBtn = el('loadBtn'), refreshVersionsBtn = el('refreshVersionsBtn');
    const highlightBtn = el('highlightBtn'), status = el('status'), debug = el('debug'), timer = el('timer');
    const saveModal = el('saveModal'), versionName = el('versionName'), versionComment = el('versionComment'), createdBy = el('createdBy');
    const closeModal = el('closeModal'), saveVersionBtn = el('saveVersionBtn');

    const PROMPTS = [
      { id: 'htPrompt', type: 'home_truth', node: 'Prompt Template-9r1K1', name: 'HomeTruth Cleaner Prompt' },
      { id: 'ldPrompt', type: 'long_description', node: 'Prompt Template-AVk4F', name: 'Long Description Cleaner Prompt' },
      { id: 'sdPrompt', type: 'short_description', node: 'Prompt Template-Bxpqm', name: 'Short Description Cleaner Prompt' }
    ];

    const OUTPUTS = [
      { id: 'origHT', componentId: 'ChatOutput-Fp0ki', keys: ['original','ht'] },
      { id: 'updatedHT', componentId: 'ChatOutput-18d66', keys: ['updated','ht'] },
      { id: 'origLD', componentId: 'ChatOutput-1WD38', keys: ['original','longdescription'] },
      { id: 'updatedLD', componentId: 'ChatOutput-iGPZo', keys: ['updated','longdescription'] },
      { id: 'origSD', componentId: 'ChatOutput-h78H1', keys: ['original','shortdescription'] },
      { id: 'updatedSD', componentId: 'ChatOutput-z0fR9', keys: ['updated','shortdescription'] }
    ];

    const promptTypeMap = { home_truth: 'htPrompt', long_description: 'ldPrompt', short_description: 'sdPrompt' };
    const versionTypeList = ['home_truth', 'long_description', 'short_description'];

    let timerInterval = null, isRunning = false, ignoreResult = false, currentPromptType = null, highlightOn = false;

    const getBaseUrl = () => baseUrl.value.trim().replace(/\/+$/, '');
    const getFlowId = () => flowId.value.trim();
    const draftKey = type => `draft:${PROJECT}:${type}`;
    const localVerKey = type => `versions:${PROJECT}:${type}`;

    function setStatus(type, msg) { status.textContent = msg; status.className = 'status-bar' + (type ? ` ${type}` : ''); }
    function setDebug(msg) { debug.style.display = msg ? 'block' : 'none'; debug.textContent = msg || ''; }
    function buildAuthHeaders(key) { return authMode.value === 'bearer' ? { Authorization: `Bearer ${key}` } : { 'x-api-key': key }; }

    function normalize(s) { return (s || '').toLowerCase().replace(/[^a-z0-9]/g, ''); }
    function extractOutputText(m) {
      return m?.results?.message?.text || m?.results?.message?.content || m?.results?.text || m?.results?.output || m?.message?.text || '';
    }
    function findOutput(outputs, spec) {
      if (spec.componentId) {
        const byId = outputs.find(o => o.component_id === spec.componentId);
        const t = extractOutputText(byId);
        if (t) return t;
      }
      const keys = (spec.keys || []).map(normalize);
      const byKeys = outputs.find(o => {
        const n = normalize(o.component_display_name), i = normalize(o.component_id);
        return keys.every(k => n.includes(k) || i.includes(k));
      });
      return extractOutputText(byKeys) || '‚Äî';
    }

    function setOutput(id, text) {
      const node = el(id);
      node.dataset.raw = text || '';
      if (highlightOn) {
        const terms = ['pack','cleaning','bed','beds','made on arrival','‚Ç¨','euro','fee'];
        const rgx = new RegExp(`\\b(${terms.map(t => t.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')).join('|')})\\b`, 'gi');
        node.innerHTML = (node.dataset.raw || '‚Äî').replace(rgx, '<span class="fee-highlight">$1</span>').replace(/‚Ç¨/g, '<span class="fee-highlight">‚Ç¨</span>');
      } else {
        node.textContent = node.dataset.raw || '‚Äî';
      }
    }

    function autoResize(t) { if (!t) return; t.style.height = 'auto'; t.style.height = `${t.scrollHeight}px`; }
    function saveDraft(type, val) { localStorage.setItem(draftKey(type), val || ''); }
    function loadDraft(type) { return localStorage.getItem(draftKey(type)) || ''; }

    function startTimer() {
      const s = Date.now();
      timer.textContent = '‚è± 0s';
      timerInterval = setInterval(() => { timer.textContent = `‚è± ${Math.round((Date.now() - s) / 1000)}s`; }, 1000);
    }
    function stopTimer() { clearInterval(timerInterval); }

    async function copyFrom(id, btn) {
      const node = el(id);
      const txt = node.value !== undefined ? node.value : (node.dataset.raw || node.textContent || '');
      try { await navigator.clipboard.writeText(txt); } catch {}
      if (btn) { btn.textContent = 'üìã Copied!'; btn.classList.add('copied'); setTimeout(() => { btn.textContent = 'üìã'; btn.classList.remove('copied'); }, 1000); }
      setStatus('success', 'Copied');
    }
    window.copyFrom = copyFrom;

    function openSaveModal(type) { currentPromptType = type; versionName.value = ''; versionComment.value = ''; saveModal.style.display = 'flex'; }
    function closeSaveModalFn() { saveModal.style.display = 'none'; currentPromptType = null; }
    window.openSaveModal = openSaveModal;

    function readLocalVersions(type) {
      try { return JSON.parse(localStorage.getItem(localVerKey(type)) || '[]'); } catch { return []; }
    }
    function writeLocalVersions(type, arr) { localStorage.setItem(localVerKey(type), JSON.stringify(arr || [])); }

    function populateVersionSelect(type, list) {
      const s = el(`versions-${type}`);
      if (!s) return;
      s.innerHTML = '';
      const d = document.createElement('option');
      d.value = ''; d.textContent = 'Load saved version...'; s.appendChild(d);
      list.forEach(v => {
        const o = document.createElement('option');
        o.value = v.id;
        o.textContent = `${v.versionName || 'Untitled'}${v.createdBy ? ' - ' + v.createdBy : ''}`;
        s.appendChild(o);
      });
    }

    async function fetchRemoteVersions() {
      const qs = new URLSearchParams({ project: PROJECT, flow_id: getFlowId() });
      const res = await fetch(`${GAS_URL}?${qs.toString()}`);
      const txt = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0, 400)}`);
      const json = txt ? JSON.parse(txt) : {};
      if (json.error) throw new Error(json.error);
      return (json.versions || []).map(v => ({
        id: v.id || `${v.timestamp || Date.now()}-${v.promptType || v.prompt_type}`,
        flowId: v.flowId || v.flow_id || '',
        promptType: (v.promptType || v.prompt_type || '').toLowerCase(),
        versionName: v.versionName || v.version_name || '',
        comment: v.comment || '',
        promptText: v.promptText || v.prompt_text || '',
        createdBy: v.createdBy || v.created_by || ''
      }));
    }

    async function refreshSavedVersions() {
      setDebug('');
      try {
        const remote = await fetchRemoteVersions();
        versionTypeList.forEach(type => {
          const local = readLocalVersions(type);
          const merged = [...remote.filter(r => r.promptType === type), ...local]
            .filter((v, i, a) => a.findIndex(x => x.id === v.id) === i)
            .slice(0, 100);
          writeLocalVersions(type, merged);
          populateVersionSelect(type, merged);
        });
        setStatus('success', 'Saved versions loaded');
      } catch (e) {
        versionTypeList.forEach(type => populateVersionSelect(type, readLocalVersions(type)));
        setStatus('error', 'Failed to fetch saved versions');
        setDebug(String(e.message || e));
      }
    }

    function onVersionSelected(type, id) {
      if (!id) return;
      const list = readLocalVersions(type);
      const v = list.find(x => x.id === id);
      if (!v) return;
      const target = el(promptTypeMap[type]);
      target.value = v.promptText || '';
      saveDraft(type, target.value);
      autoResize(target);
      setStatus('success', 'Version loaded');
      el(`versions-${type}`).value = '';
    }

    async function loadPrompts() {
      const key = apiKey.value.trim();
      if (!key) return setStatus('error', 'API key required');
      if (!getFlowId()) return setStatus('error', 'Flow ID required');

      setStatus('loading', 'Loading prompts from Langflow...');
      setDebug('');

      try {
        const res = await fetch(`${getBaseUrl()}/api/v1/flows/${getFlowId()}`, { headers: buildAuthHeaders(key) });
        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0, 400)}`);
        const flow = txt ? JSON.parse(txt) : {};
        const nodes = flow?.data?.nodes || flow?.data?.data?.nodes || flow?.nodes || [];

        PROMPTS.forEach(p => {
          const n = nodes.find(x => x.id === p.node) || nodes.find(x => x?.data?.node?.display_name === p.name);
          const val = n?.data?.node?.template?.template?.value ?? n?.data?.node?.template?.value ?? n?.data?.template?.template?.value ?? n?.data?.template?.value ?? '';
          const t = el(p.id);
          t.value = val;
          saveDraft(p.type, val);
          autoResize(t);
        });

        setStatus('success', 'Prompts loaded');
      } catch (e) {
        setStatus('error', 'Failed to load prompts');
        setDebug(String(e.message || e));
      }
    }

    async function runFlow() {
      if (isRunning) return;
      const key = apiKey.value.trim();
      if (!key) return setStatus('error', 'API key required');
      if (!entityId.value.trim()) return setStatus('error', 'Property ID required');
      if (!getFlowId()) return setStatus('error', 'Flow ID required');

      isRunning = true; ignoreResult = false;
      runBtn.disabled = true; runBtn.textContent = '‚è≥ Running...'; cancelBtn.style.display = 'inline-block';
      setStatus('loading', 'Running flow...'); setDebug(''); startTimer();

      try {
        const tweaks = {};
        PROMPTS.forEach(p => {
          const v = el(p.id).value.trim();
          if (v) tweaks[p.node] = { template: v };
        });

        const res = await fetch(`${getBaseUrl()}/api/v1/run/${getFlowId()}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', ...buildAuthHeaders(key) },
          body: JSON.stringify({ input_type: 'chat', output_type: 'chat', input_value: entityId.value.trim(), tweaks })
        });

        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0, 700)}`);
        const json = txt ? JSON.parse(txt) : {};
        if (ignoreResult) return;

        const outputs = json?.outputs?.[0]?.outputs || [];
        OUTPUTS.forEach(spec => setOutput(spec.id, findOutput(outputs, spec)));
        setStatus('success', 'Flow completed');
      } catch (e) {
        if (!ignoreResult) { setStatus('error', 'Flow failed'); setDebug(String(e.message || e)); }
      } finally {
        isRunning = false;
        runBtn.disabled = false; runBtn.textContent = 'üöÄ Run Flow'; cancelBtn.style.display = 'none';
        stopTimer();
      }
    }

    function cancelRun() {
      if (!isRunning) return;
      ignoreResult = true; isRunning = false;
      runBtn.disabled = false; runBtn.textContent = 'üöÄ Run Flow'; cancelBtn.style.display = 'none';
      stopTimer(); setStatus('error', 'Run cancelled');
    }

    async function savePromptVersion() {
      if (!currentPromptType) return;
      const target = el(promptTypeMap[currentPromptType]);
      const promptText = target.value || '';
      if (!promptText.trim()) { setStatus('error', 'Prompt is empty'); closeSaveModalFn(); return; }

      const row = {
        id: String(Date.now()),
        project: PROJECT,
        flow_id: getFlowId(),
        prompt_type: currentPromptType,
        version_name: versionName.value.trim(),
        comment: versionComment.value.trim(),
        prompt_text: promptText,
        created_by: createdBy.value.trim()
      };

      try {
        const res = await fetch(GAS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body: new URLSearchParams(row)
        });
        const txt = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${txt.slice(0, 400)}`);
        const parsed = txt ? JSON.parse(txt) : {};
        if (parsed.error) throw new Error(parsed.error);

        setStatus('success', 'Saved to spreadsheet');
      } catch (e) {
        setStatus('error', 'Failed to save prompt version');
        setDebug(String(e.message || e));
      } finally {
        const local = readLocalVersions(currentPromptType);
        local.unshift({
          id: row.id,
          flowId: row.flow_id,
          promptType: row.prompt_type,
          versionName: row.version_name,
          comment: row.comment,
          promptText: row.prompt_text,
          createdBy: row.created_by
        });
        writeLocalVersions(currentPromptType, local);
        populateVersionSelect(currentPromptType, local);
        closeSaveModalFn();
      }
    }

    ['htPrompt','ldPrompt','sdPrompt'].forEach(id => {
      const t = el(id);
      t.addEventListener('input', () => {
        autoResize(t);
        const type = Object.keys(promptTypeMap).find(k => promptTypeMap[k] === id);
        if (type) saveDraft(type, t.value);
      });
    });

    highlightBtn.addEventListener('click', () => {
      highlightOn = !highlightOn;
      highlightBtn.classList.toggle('active', highlightOn);
      OUTPUTS.forEach(spec => {
        const n = el(spec.id);
        setOutput(spec.id, n.dataset.raw || n.textContent || '');
      });
    });

    runBtn.addEventListener('click', runFlow);
    cancelBtn.addEventListener('click', cancelRun);
    loadBtn.addEventListener('click', loadPrompts);
    refreshVersionsBtn.addEventListener('click', refreshSavedVersions);
    closeModal.addEventListener('click', closeSaveModalFn);
    saveVersionBtn.addEventListener('click', savePromptVersion);

    versionTypeList.forEach(type => {
      el(`versions-${type}`).addEventListener('change', e => onVersionSelected(type, e.target.value));
    });

    window.addEventListener('DOMContentLoaded', async () => {
      PROMPTS.forEach(p => {
        const t = el(p.id);
        const d = loadDraft(p.type);
        if (d) t.value = d;
        autoResize(t);
      });
      await refreshSavedVersions();
    });
  </script>
</body>
</html>
